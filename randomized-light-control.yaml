blueprint:
  name: Randomized Offset Control (Supports Scenes)
  description: >
    Activate lights/switches/scenes around sunrise, sunset, or fixed time with random ± offset.
    
    - For turn_on: Lights/switches use turn_on (with optional brightness/transition); scenes use scene.turn_on.
    - For turn_off: Only works on lights/switches (scenes have no off).
    
    Sunrise/Sunset: True ± variation.
    Fixed time: Set early trigger to base minus max offset.
  domain: automation
  input:
    trigger_type:
      name: Trigger Type
      selector:
        select:
          options:
            - sunrise
            - sunset
            - fixed
      default: sunset
    max_offset_minutes:
      name: Max Random Offset (± minutes)
      default: 30
      selector:
        number:
          min: 0
          max: 240
          unit_of_measurement: minutes
    fixed_trigger_time:
      name: Early Trigger Time (Fixed only)
      selector:
        time:
    action:
      name: Action
      selector:
        select:
          options:
            - turn_on
            - turn_off
      default: turn_on
    entities:
      name: Entities/Scenes to Control
      description: Lights, switches, or scenes
      selector:
        target:
          entity:
            domain:
              - light
              - switch
              - scene
    brightness_pct:
      name: Brightness % (Lights turn_on only, optional)
      default: 0
      selector:
        number:
          min: 0
          max: 100
    transition:
      name: Transition Seconds (Lights turn_on only, optional)
      default: 0
      selector:
        number:
          min: 0
          max: 60

trigger:
  - platform: sun
    event: sunrise
    offset: "{{ - ( !input max_offset_minutes | int(0) * 60 ) }}"
    id: sunrise
  - platform: sun
    event: sunset
    offset: "{{ - ( !input max_offset_minutes | int(0) * 60 ) }}"
    id: sunset
  - platform: time
    at: !input fixed_trigger_time
    id: fixed

action:
  - variables:
      max_offset: !input max_offset_minutes
      has_scene: "{{ 'scene' in ( !input entities.entity_id | list | map(attribute='domain') | unique | list ) }}"
      has_light_or_switch: "{{ ('light' in ( !input entities.entity_id | list | map(attribute='domain') | unique | list )) or ('switch' in ( !input entities.entity_id | list | map(attribute='domain') | unique | list )) }}"
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: and
                conditions:
                  - condition: trigger
                    id: sunrise
                  - condition: template
                    value_template: "{{ !input trigger_type == 'sunrise' }}"
              - condition: and
                conditions:
                  - condition: trigger
                    id: sunset
                  - condition: template
                    value_template: "{{ !input trigger_type == 'sunset' }}"
              - condition: and
                conditions:
                  - condition: trigger
                    id: fixed
                  - condition: template
                    value_template: "{{ !input trigger_type == 'fixed' }}"
        sequence:
          - delay:
              seconds: "{{ range(0, (2 * max_offset * 60) + 1) | random }}"
          - choose:
              - conditions: "{{ !input action == 'turn_on' and has_scene }}"
                sequence:
                  - service: scene.turn_on
                    target: !input entities
              - conditions: "{{ !input action == 'turn_on' and has_light_or_switch }}"
                sequence:
                  - service: light.turn_on
                    target: !input entities
                    data:
                      {% if !input brightness_pct | int(0) > 0 %}
                      brightness_pct: {{ !input brightness_pct }}
                      {% endif %}
                      {% if !input transition | int(0) > 0 %}
                      transition: {{ !input transition }}
                      {% endif %}
              - conditions: "{{ !input action == 'turn_off' and has_light_or_switch }}"
                sequence:
                  - service: light.turn_off  # Works for switches too in recent HA
                    target: !input entities
    default: []

mode: single
