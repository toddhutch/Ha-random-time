blueprint:
  name: Randomized Offset Device Control
  description: >
    Turn devices (lights or switches) on/off around sunrise, sunset, or fixed time with random ± offset.
    
    - Sunrise/Sunset: True ± variation (triggers early, random delay up to 2x offset).
    - Fixed time: Set "Early Trigger Time" to base time minus max offset (e.g., 20:00 ±30 → 19:30).
    
    Create separate automations for on and off.
  domain: automation
  input:
    trigger_type:
      name: Trigger Type
      selector:
        select:
          options:
            - sunrise
            - sunset
            - fixed
      default: sunset
    max_offset_minutes:
      name: Max Random Offset (± minutes)
      description: e.g., 30 for ~±30 min variation
      default: 30
      selector:
        number:
          min: 0
          max: 240
          unit_of_measurement: minutes
    fixed_trigger_time:
      name: Early Trigger Time (Fixed only)
      description: Base time minus max offset
      selector:
        time:
    action:
      name: Action
      selector:
        select:
          options:
            - turn_on
            - turn_off
      default: turn_on
    entities:
      name: Devices to Control
      selector:
        target:
          entity:
            domain:
              - light
              - switch
    brightness_pct:
      name: Brightness % (Turn On only, optional)
      description: 1-100; 0 = no change
      default: 0
      selector:
        number:
          min: 0
          max: 100
    transition:
      name: Transition Seconds (Turn On only, optional)
      default: 0
      selector:
        number:
          min: 0
          max: 60

trigger:
  - platform: sun
    event: sunrise
    offset: "{{ - ( !input max_offset_minutes | int(0) * 60 ) }}"
    id: sunrise
  - platform: sun
    event: sunset
    offset: "{{ - ( !input max_offset_minutes | int(0) * 60 ) }}"
    id: sunset
  - platform: time
    at: !input fixed_trigger_time
    id: fixed

condition: []

action:
  - variables:
      max_offset: !input max_offset_minutes
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: and
                conditions:
                  - condition: trigger
                    id: sunrise
                  - condition: template
                    value_template: "{{ !input trigger_type == 'sunrise' }}"
              - condition: and
                conditions:
                  - condition: trigger
                    id: sunset
                  - condition: template
                    value_template: "{{ !input trigger_type == 'sunset' }}"
              - condition: and
                conditions:
                  - condition: trigger
                    id: fixed
                  - condition: template
                    value_template: "{{ !input trigger_type == 'fixed' }}"
        sequence:
          - delay:
              seconds: "{{ range(0, (2 * max_offset * 60) + 1) | random }}"
          - service: >-
              {% if is_state_attr(!input entities.entity_id | list, 'domain', 'switch') or 'switch' in (!input entities.entity_id | list | map(attribute='domain') | unique) %}
              switch.{{ !input action }}
              {% else %}
              light.{{ !input action }}
              {% endif %}
            target: !input entities
            data: >-
              {% if !input action == 'turn_on' %}
              {% set bp = !input brightness_pct | int(0) %}
              {% set tr = !input transition | int(0) %}
              {{ {'brightness_pct': bp} if bp > 0 else {} | combine({'transition': tr} if tr > 0 else {}) }}
              {% else %}
              {}
              {% endif %}
    default: []

mode: single
